<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0"><meta name="description" content="Presto The Definitive Guide 读书笔记1-Presto Architecture [ Baoqp's Blog ] "><meta name="theme-color" content="#9be3de"><title>Presto The Definitive Guide 读书笔记1-Presto Architecture [ Baoqp's Blog ] </title><style>@font-face {
  font-family: 'Abril Fatface';
  font-style: normal;
  font-weight: 400;
  src: local('Abril Fatface'), local('AbrilFatface-Regular'), url(data:font/woff2;base64,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) format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Abril Fatface';
  font-style: normal;
  font-weight: 400;
  src: local('Abril Fatface'), local('AbrilFatface-Regular'), url(data:font/woff2;base64,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BL3+M1K+NfPvjlJEHZTOrkYvtdprqx0Hka+W/IhsQoUJE0jsPVOhV2itgp3Wame8dsB73DeCOfp+FMSxp2At3aozP1zVQ/tmEpXdveum7kat3CaLXRcmTZHmOveMiqxSteCZOrGKmscOa9WycTUXtRFabrtts1Nb3e5qHtqWPMWtuEkMSdydcarhKoTcVXtBgujKwULbPFJvqywIzBjboUacECG6ajlIews5dBUMkJ/LYHa12gpRLEsBDAAA6raxOaTnbx4GG5J6hdn4twxT1DRvEQZvD6banOa3BbstVh48efHmw5cffwECBQkWIvK/LTbhIkSKEi1GrDjxEiRKkixFqjTpMmTKki1Hrjz5ChQqUqxEqTLlKlSqUq2e+hpoqJHGmmiqmeZhWGKoYfaZ7qXhxhtjnlWWxsBotw0xxWdfjDPDSEfc98l8q33z1XeLrXPKCeu10NJErZzR2kmnXXDWOee90sYVF12yQVsfTXLdVde088Y7o3TQXkedddLFQnb/qVGrq24cuuvhtZ5666WPfvraaZEB+htokLfe2+1GBDbalARuuueWzbbYboejttrmmBHW2O+AvUmRDMb6EEUsHHQoDskRjxRIiVRILev2qn1oaGpomZOB2z/jmn/eUk6tvaZda/5znbhPCguQ7wsEvd1strBI3OYR8ye01+ZO0jbH36oqKm37w90hl2v/wO5o3vIjtpoZx20H) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
</style><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/css/index.css"><script src="https://cdn.bootcss.com/highlight.js/9.6.0/highlight.min.js" defer></script><script src="/js/paper.js" defer></script><script src="https://www.googletagmanager.com/gtag/js?id=xx-xxxxxxx-xx" async></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'xx-xxxxxxx-xx');</script><link rel="stylesheet" href="/css/tocbot.css"><script src="/js/tocbot.js" defer></script><script>window.addEventListener('DOMContentLoaded', () => {
  tocbot.init({
    // Where to render the table of contents.
    tocSelector: '.toc__content',
    // Where to grab the headings to build the table of contents.
    contentSelector: '.article__content',
    // Which headings to grab inside of the contentSelector element.
    headingSelector: 'h1, h2, h3, h4, h5, h6',
    // For headings inside relative or absolute positioned containers within content.
    hasInnerContainers: true,
    orderedList: false,
    collapseDepth: 2,
  });
})</script><link rel="preload" href="https://cdn.bootcss.com/highlight.js/9.6.0/styles/github.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><link rel="stylesheet" href="https://cdn.bootcss.com/highlight.js/9.6.0/styles/github.min.css"><link rel="preload" href="https://fonts.googleapis.com/css?family=Abril+Fatface&amp;display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface&amp;display=swap"><meta name="generator" content="Hexo 5.4.1"></head><body><div class="mask-border"></div><div class="head"><div class="head__inner"><h1><a href="/">Baoqp's Blog</a></h1><p></p></div></div><div class="paper-container"><div class="main"><div class="location-bar"><div class="line-1"><div class="horizontal-line" style="height: 3px"></div></div><div class="line-2"><div class="horizontal-line" style="height: 1px"></div></div><p class="text">Presto The Definitive Guide 读书笔记1-Presto Architecture</p><div class="switch-button"><input class="container_toggle" type="checkbox" id="switch" name="mode"><label for="switch">Toggle</label></div><div class="line-3"><div class="horizontal-line" style="height: 1px"></div></div></div><div class="main__2-col"><article class="post-view__article"><div class="article__infomation"><div class="posts-item"><h2 class="posts-item__title"><a href="">Presto The Definitive Guide 读书笔记1-Presto Architecture</a></h2><span class="post__date">2020-08-23</span><a href="/tags/Presto/"><span class="post__tags">#Presto</span></a></div></div><div class="article__content"><h2 id="Presto-Architecture"><a href="#Presto-Architecture" class="headerlink" title="Presto Architecture"></a>Presto Architecture</h2><h3 id="Coordinator-and-Workers-in-a-Cluster"><a href="#Coordinator-and-Workers-in-a-Cluster" class="headerlink" title="Coordinator and Workers in a Cluster"></a>Coordinator and Workers in a Cluster</h3><p>Presto是一个MPP（massively parallel processing）架构的查询引擎，可以水平扩展。Presot总体架构如下图所示，由1个协调节点和多个工作节点组成。客户端通过JDBC或CLI连接到协调节点。</p>
<img src="ptdg_0401.png" alt="Presto architecture overview with coordinator and workers" style="zoom: 67%;" />

<p>协调节点负责接收用户请求和管理工作节点，协调节点上有个<em>发现服务（discovery service）</em>，并允许工作节点注册并加入集群。客户端、协调节点、工作节点间的通信和数据传输都基于HTTP(S)。</p>
<p>下图显示了集群内工协调节点和工作节点之间的通信。协调节点与工作节点通信以分配任务、更新状态并获取顶层结果集以返回给用户。工作节点之间互相通信，从上游任务中获取数据。工作节点也负责从数据源获取数据。</p>
<img src="ptdg_0402.png" alt="Communication between coordinator and workers in a Presto cluster" style="zoom:67%;" />





<h3 id="Connector-Based-Architecture"><a href="#Connector-Based-Architecture" class="headerlink" title="Connector-Based Architecture"></a>Connector-Based Architecture</h3><p>Presto中存储和计算分离的核心是基于连接器（connector）的体系结构。连接器为访问任意数据源提供了接口。每个连接器在底层数据源上提供了基于表的抽象。只要可以使用Presto中可用数据类型以表、列和行的形式表示数据，就可以创建连接器，Presto就可以使用这些数据进行查询处理。</p>
<p>Presto基于<em>SPI（service provider interface）</em>机制，规定了connector要实现的API接口，主要包括以下三部分：</p>
<ul>
<li>获取 table/view/schema元数据的操作</li>
<li>产生数据分区的逻辑单元的操作，这样Presto可以并行读写</li>
<li>将源数据转换为查询引擎所需的内存格式的数据源（sources ）和汇（sink）</li>
</ul>
<img src="ptdg_0405.png" alt="Overview of the Presto service provider interface (SPI)" style="zoom:67%;" />



<h3 id="Query-Execution-Model"><a href="#Query-Execution-Model" class="headerlink" title="Query Execution Model"></a>Query Execution Model</h3><p>协调者在接收到提交的SQL后，会进行解析，生产执行计划。</p>
<img src="ptdg_0406.png" alt="Processing a SQL query statement to create a query plan" style="zoom:67%;" />

<p>在生成执行计划的过程中，会用到Metadata SPI和DataStatistics SPI。其中，前者用于校验查询在语义上是否有效，并对于语句中的表达式进行类型检查和安全性检查。后者用于获取记录行数和表的大小等以用于基于成本的查询优化（cost-based query optimizations）。</p>
<img src="ptdg_0407.png" alt="The service provider interfaces for query planning and scheduling" style="zoom:67%;" />

<p>DataLocation SPI在创建分布式查询计划时会用到，其主要用于生成表内容的logical splits。split是最小的工作分配和并行单位。</p>
<p>分布式查询计划是简单查询计划的扩展，由一个或多个阶段（stage）组成的。简单的查询计划被切分成<em>计划片段（plan fragment）</em>。阶段是计划片段的运行时体现，它包含了计划片段所描述的所有任务。</p>
<p>协调节点将计划分解可以充分利用集群中的工作节点以并行方式进行处理。拥有多个阶段会生成一个阶段的依赖树。阶段的数量取决于查询的复杂度。下图大致说明了如何把逻辑查询计划转化为分布式查询计划。</p>
<img src="ptdg_0408.png" alt="Transformation of the query plan to a distributed query plan*" style="zoom:50%;" />



<p>分布式查询计划决定了在Presto集群上执行查询的阶段和方式。协调节点使用它来进一步计划和安排工作节点的任务。阶段由一个或多个任务（task）组成。通常，会涉及到许多任务，每个任务处理一段数据。</p>
<p>协调节点会将一个阶段中的任务分配给集群中的工作节点，如下图所示。</p>
<img src="ptdg_0409.png" alt="Task management performed by the coordinator" style="zoom:50%;" />

<p>split是任务处理数据的单元。例如，Hive连接器以”文件路径+偏移量+长度”的形式描述split，表明了需要处理文件的部分。</p>
<p>源阶段（source stage）的任务以页（page）的形式生成数据，页是列格式的行集合。这些页流向其他的中间下游阶段。页由交换算子（exchange operator）在阶段之间传输，交换算子从上游阶段内的任务中读取数据。</p>
<img src="ptdg_0410.png" alt="Data in splits is transferred between tasks and processed on different workers" style="zoom:50%;" />

<p>因此，任务是分配给工作节点的计划片段的运行时体现。任务创建后，它为每个split实例化一个<em>driver</em>。每个driver都是算子管道的实例化，并处理split中的数据。根据配置和环境，一个任务内可以有多个drivers.</p>
<img src="ptdg_0411.png" alt="Parallel drivers in a task with input and output splits" style="zoom: 67%;" />



<h3 id="Query-Planning"><a href="#Query-Planning" class="headerlink" title="Query Planning"></a>Query Planning</h3><p>在构建查询计划之前，需要对SQL语句进行解析和分析。主要步骤包括：</p>
<ol>
<li>识别查询语句中的表</li>
<li>识别查询语句中的列</li>
<li>识别对行值内字段的引用：比如从c.bonus可能是表c或别名为c的表的字段bonus，也可能是字段c中的属性bonus（具有命名属性的结构体）</li>
</ol>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span><br>    (<span class="hljs-keyword">SELECT</span> name <span class="hljs-keyword">FROM</span> region r <span class="hljs-keyword">WHERE</span> regionkey <span class="hljs-operator">=</span> n.regionkey) <span class="hljs-keyword">AS</span> region_name,<br>    n.name <span class="hljs-keyword">AS</span> nation_name,<br>    <span class="hljs-built_in">sum</span>(totalprice) orders_sum<br><span class="hljs-keyword">FROM</span> nation n, orders o, customer c<br><span class="hljs-keyword">WHERE</span> n.nationkey <span class="hljs-operator">=</span> c.nationkey<br>  <span class="hljs-keyword">AND</span> c.custkey <span class="hljs-operator">=</span> o.custkey<br><span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> n.nationkey, regionkey, n.name<br><span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> orders_sum <span class="hljs-keyword">DESC</span><br>LIMIT <span class="hljs-number">5</span>;<br></code></pre></td></tr></table></figure>

<p>对于以上sql会解析成如下计划</p>
<figure class="highlight css"><table><tr><td class="code"><pre><code class="hljs css">- Limit<span class="hljs-selector-attr">[5]</span><br>  - Sort<span class="hljs-selector-attr">[orders_sum DESC]</span><br>    - LateralJoin<span class="hljs-selector-attr">[2]</span><br>      - Aggregate<span class="hljs-selector-attr">[by nationkey...; orders_sum := sum(totalprice)]</span><br>       - <span class="hljs-attribute">Filter</span><span class="hljs-selector-attr">[c.nationkey = n.nationkey AND c.custkey = o.custkey]</span><br>          - CrossJoin<br>            - CrossJoin<br>              - TableScan<span class="hljs-selector-attr">[nation]</span><br>              - TableScan<span class="hljs-selector-attr">[orders]</span><br>            - TableScan<span class="hljs-selector-attr">[customer]</span><br>      - EnforceSingleRow<span class="hljs-selector-attr">[region_name := r.name]</span><br>        - <span class="hljs-attribute">Filter</span><span class="hljs-selector-attr">[r.regionkey = n.regionkey]</span><br>          - TableScan<span class="hljs-selector-attr">[region]</span><br></code></pre></td></tr></table></figure>

<p> 假如用<em>N</em>, <em>O</em>, <em>C</em>, <em>R</em> 分别表示<code>nation</code>, <code>orders</code>, <code>customer</code>, <code>region</code>表中的记录数，那么</p>
<ul>
<li>三个表TableScan后的CrossJoin的复杂度是Ω(<em>N</em> × <em>O</em> × <em>C</em>)</li>
<li>TableScan[region]的复杂度是 Ω(<em>R</em>)，由于存在LateralJoin，需要执行N次，因此总的计算成本是Ω(<em>R</em> × <em>N</em>)</li>
<li>排序操作的成本是 <em>N</em> × log(<em>N</em>)</li>
</ul>
<p>因此总的成本至少为Ω[<em>N</em> + <em>O</em> + <em>C</em> + (<em>N</em> × <em>O</em>) + (<em>N</em> × <em>O</em> × <em>C</em>) + (<em>R</em> × <em>N</em>) + (<em>N</em> × log(<em>N</em>))]，可以简化为Ω[(<em>N</em> × <em>O</em> × <em>C</em>) + (<em>R</em> × <em>N</em>) + (N × log(<em>N</em>))]，现加上一个合理的假设即region表是最小的，nation表次之，那么再次简化为Ω(<em>N</em> × <em>O</em> × <em>C</em>)。</p>
<h3 id="Optimization-Rules"><a href="#Optimization-Rules" class="headerlink" title="Optimization Rules"></a>Optimization Rules</h3><h4 id="谓词下推（Predicate-Pushdown）"><a href="#谓词下推（Predicate-Pushdown）" class="headerlink" title="谓词下推（Predicate Pushdown）"></a>谓词下推（Predicate Pushdown）</h4><p>谓词下推是最简单也是最重要的优化策略，它把过滤条件下推以尽可能靠近数据源。从而，在查询执行期间尽早进行数据缩减。</p>
<p>比如下面把CrossJoin和Filter转换为InnerJoin。用生成的记录行来表示计算复杂度的话，那么此次谓词下推可以把复杂度由 Ω(<em>N</em> × <em>O</em> × <em>C</em>)缩小为Θ(<em>N</em> × <em>O</em>)。但是nation和order的CrossJoin不能优化为InnerJoin，因为没有直接的条件（condition）来连接这两个表。</p>
<figure class="highlight scss"><table><tr><td class="code"><pre><code class="hljs scss">...<br>- Aggregate<span class="hljs-selector-attr">[by nationkey...; orders_sum := sum(totalprice)]</span><br>  - <span class="hljs-attribute">Filter</span><span class="hljs-selector-attr">[c.nationkey = n.nationkey AND c.custkey = o.custkey]</span>  <span class="hljs-comment">// original filter</span><br>    - CrossJoin<br>      - CrossJoin<br>        - TableScan<span class="hljs-selector-attr">[nation]</span><br>        - TableScan<span class="hljs-selector-attr">[orders]</span><br>      - TableScan<span class="hljs-selector-attr">[customer]</span><br>...<br>...<br>- Aggregate<span class="hljs-selector-attr">[by nationkey...; orders_sum := sum(totalprice)]</span><br>  - <span class="hljs-attribute">Filter</span><span class="hljs-selector-attr">[c.nationkey = n.nationkey]</span>              <span class="hljs-comment">// transformed simpler filter</span><br>    - InnerJoin<span class="hljs-selector-attr">[o.custkey = c.custkey]</span>             <span class="hljs-comment">// added inner join</span><br>      - CrossJoin<br>        - TableScan<span class="hljs-selector-attr">[nation]</span><br>        - TableScan<span class="hljs-selector-attr">[orders]</span><br>      - TableScan<span class="hljs-selector-attr">[customer]</span><br>...<br></code></pre></td></tr></table></figure>



<h4 id="CrossJoin消除"><a href="#CrossJoin消除" class="headerlink" title="CrossJoin消除"></a>CrossJoin消除</h4><p>CrossJoin消除会重排序表的连接顺序，以最小化CrossJoin的数量，理想情况下是将其减少到零。在前一节的基础上，修改join的顺序，可以把CrossJoin都转换为InnerJoin。此时join的成本就变成了Θ(<em>C</em> + <em>O</em>) = Θ(<em>O</em>). 由于其他部分未变，那么总的查询成本至少是Ω[<em>O</em> + (<em>R</em> × <em>N</em>) + (<em>N</em> × log(<em>N</em>))]。</p>
<figure class="highlight scss"><table><tr><td class="code"><pre><code class="hljs scss">...<span class="hljs-selector-attr">[i]</span><br>  - Aggregate<span class="hljs-selector-attr">[by nationkey...; orders_sum := sum(totalprice)]</span><br>    - <span class="hljs-attribute">Filter</span><span class="hljs-selector-attr">[c.nationkey = n.nationkey]</span>          <span class="hljs-comment">// filter on nationkey first</span><br>      - InnerJoin<span class="hljs-selector-attr">[o.custkey = c.custkey]</span>         <span class="hljs-comment">// then inner join cutkey</span><br>        - CrossJoin<br>          - TableScan<span class="hljs-selector-attr">[nation]</span><br>          - TableScan<span class="hljs-selector-attr">[orders]</span><br>        - TableScan<span class="hljs-selector-attr">[customer]</span><br>...<br>...<br>  - Aggregate<span class="hljs-selector-attr">[by nationkey...; orders_sum := sum(totalprice)]</span><br>    - InnerJoin<span class="hljs-selector-attr">[c.custkey = o.custkey]</span>          <span class="hljs-comment">// reordered to custkey first</span><br>      - InnerJoin<span class="hljs-selector-attr">[n.nationkey = c.nationkey]</span>    <span class="hljs-comment">// then nationkey</span><br>        - TableScan<span class="hljs-selector-attr">[nation]</span><br>        - TableScan<span class="hljs-selector-attr">[customer]</span><br>      - TableScan<span class="hljs-selector-attr">[orders]</span><br>...<br></code></pre></td></tr></table></figure>



<h4 id="TopN"><a href="#TopN" class="headerlink" title="TopN"></a>TopN</h4><p>对于OrderBy+Limit操作，如果采用先返回所有记录再排序的方式，那么计算成本为Θ(<em>row_count</em> × log(<em>row_count</em>))，内存占用为Θ(<em>row_count</em>)。如果在OrderBy+Limit之后加一个TopN节点，该节点中维护一个堆，在输入数据来会不断更新堆，那么计算成本可以优化为Θ(<em>row_count</em> × log(<em>limit</em>)) ，内存占用优化为Θ(<em>limit</em>)。此时上述查询例子的总成本优化为Ω[<em>O</em> + (<em>R</em> × <em>N</em>) + <em>N</em>]。</p>
<h4 id="部分聚合（Partial-Aggregations）"><a href="#部分聚合（Partial-Aggregations）" class="headerlink" title="部分聚合（Partial Aggregations）"></a>部分聚合（Partial Aggregations）</h4><p>在上述的查询例子中，并不需要把orders表中的所有记录都传给join操作，因为我们并不对单个订单感兴趣。由于我们的查询是对属于每个国家的订单执行聚合操作，那么可以先执行如下的聚合操作以减少发送给下游操作的数据。该聚合操作的结果并不完整，因此称为预聚合（<em>pre-aggregation</em>）。</p>
<figure class="highlight prolog"><table><tr><td class="code"><pre><code class="hljs prolog">...<br>- <span class="hljs-symbol">Aggregate</span>[by nationkey...; orders_sum := sum(totalprice)]<br>  - <span class="hljs-symbol">InnerJoin</span>[c.custkey = o.custkey]<br>    - <span class="hljs-symbol">InnerJoin</span>[n.nationkey = c.nationkey]<br>      - <span class="hljs-symbol">TableScan</span>[nation]<br>      - <span class="hljs-symbol">TableScan</span>[customer]<br>    - <span class="hljs-symbol">Aggregate</span>[by custkey; totalprice := sum(totalprice)]<br>      - <span class="hljs-symbol">TableScan</span>[orders]<br>...<br></code></pre></td></tr></table></figure>

<p>注：预聚合并不总是能带来提升，当预聚合不能减少数据量时反而会降低查询性能。因此该优化默认是关闭的，可以通过push_partial_aggregation_through_join参数来设置是否使用。默认情况下，Presto在join之后使用部分聚合，以减少Presto节点之间通过网络传输的数据量。</p>
<h3 id="Implementation-Rules"><a href="#Implementation-Rules" class="headerlink" title="Implementation Rules"></a>Implementation Rules</h3><h4 id="Lateral-Join-Decorrelation"><a href="#Lateral-Join-Decorrelation" class="headerlink" title="Lateral Join Decorrelation"></a>Lateral Join Decorrelation</h4><p>Lateral Join可以实现为for-each循环，它遍历数据集中的所有行，并对每一行执行另一个查询。但是Presto中不是这样实现的，Presto会解除关联的子查询，把关联的查询条件上提，并组成一个left join。如果sql描述，那就是如下的转换</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">SELECT</span><br>    (<span class="hljs-keyword">SELECT</span> <span class="hljs-type">name</span> <span class="hljs-keyword">FROM</span> region r <span class="hljs-keyword">WHERE</span> regionkey = n.regionkey)<br>        <span class="hljs-keyword">AS</span> region_name,<br>    n.name <span class="hljs-keyword">AS</span> nation_name<br><span class="hljs-keyword">FROM</span> nation n<br><br>-&gt; 转换为<br><br><span class="hljs-keyword">SELECT</span><br>    r.name <span class="hljs-keyword">AS</span> region_name,<br>    n.name <span class="hljs-keyword">AS</span> nation_name<br><span class="hljs-keyword">FROM</span> nation n <span class="hljs-keyword">LEFT OUTER JOIN</span> region r <span class="hljs-keyword">ON</span> r.regionkey = n.regionkey<br></code></pre></td></tr></table></figure>

<p>但事实上这两个sql语句并不等价。如果region表中有多条记录有相同regionkey，那么第一个语句会报错，但是第二个语句并不会，且会返回多条记录。因此，在转换为join之后，还要有两个附加操作，首先给源表中的所有行编号以便进行区分，其次检查是否有重复，如果有则报错。</p>
<figure class="highlight nestedtext"><table><tr><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-bullet">-</span> <span class="hljs-string">TopN[5; orders_sum DESC]</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">MarkDistinct &amp; Check</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">LeftJoin[n.regionkey = r.regionkey]</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">AssignUniqueId</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">Aggregate[by nationkey...; orders_sum := sum(totalprice)]</span><br>         <span class="hljs-bullet">-</span> <span class="hljs-string">...</span><br>     <span class="hljs-bullet">-</span> <span class="hljs-string">TableScan[region]</span><br></code></pre></td></tr></table></figure>



<h4 id="Semi-Join-IN-Decorrelation"><a href="#Semi-Join-IN-Decorrelation" class="headerlink" title="Semi-Join (IN) Decorrelation"></a>Semi-Join (IN) Decorrelation</h4><p>子查询还可以放在IN谓词中用于过滤记录行。IN谓词可以出现在过滤（WHERE子句）中或projection（SELECT子句）中。当在projection中使用IN谓词时，它不再是一个简单的布尔类型的操作符，其返回值为<code>true</code>, <code>false</code> 或<code>null</code>。</p>
<p>考虑一个查询如下，该查询旨在查找客户和项目供应商来自同一国家/地区的订单。</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> o.orderkey<br><span class="hljs-keyword">FROM</span> lineitem l<br>  <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> o.orderkey = l.orderkey<br>  <span class="hljs-keyword">JOIN</span> customer c <span class="hljs-keyword">ON</span> o.custkey = c.custkey<br><span class="hljs-keyword">WHERE</span> c.nationkey <span class="hljs-keyword">IN</span> (<br>    <span class="hljs-comment">-- subquery invoked multiple times</span><br>    <span class="hljs-keyword">SELECT</span> s.nationkey<br>    <span class="hljs-keyword">FROM</span> part p<br>      <span class="hljs-keyword">JOIN</span> partsupp ps <span class="hljs-keyword">ON</span> p.partkey = ps.partkey<br>      <span class="hljs-keyword">JOIN</span> supplier s <span class="hljs-keyword">ON</span> ps.suppkey = s.suppkey<br>    <span class="hljs-keyword">WHERE</span> p.partkey = l.partkey<br>);<br></code></pre></td></tr></table></figure>



<p>与lateral join类似，上面的查询也可以实现为循环外部查询的结果，并对结果中每条记录执行子查询。Presto没有采用这种方式，而是解除关联，首先去掉关联条件执行子查询，然后使用关联关系把子查询结果关联回外部查询。The tricky part is ensuring that the join does not multiply result rows (so a deduplicating aggregation is used) and that the transformation correctly retains the <code>IN</code> predicate’s three-valued logic.</p>
<p>在这种情况下，如果用于去重的聚合和join使用相同的分区方式，那么可以以流的方式处理，而不需要新加exchange节点，这样也可以减少内存占用。</p>
<h3 id="Cost-Based-Optimizer"><a href="#Cost-Based-Optimizer" class="headerlink" title="Cost-Based Optimizer"></a>Cost-Based Optimizer</h3><p>在本节考虑以下查询语句</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">SELECT</span><br>    n.name <span class="hljs-keyword">AS</span> nation_name,<br>    avg(extendedprice) <span class="hljs-keyword">as</span> avg_price<br><span class="hljs-keyword">FROM</span> nation n, orders o, customer c, lineitem l<br><span class="hljs-keyword">WHERE</span> n.nationkey = c.nationkey<br>  <span class="hljs-keyword">AND</span> c.custkey = o.custkey<br>  <span class="hljs-keyword">AND</span> o.orderkey = l.orderkey<br><span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> n.nationkey, n.name;<br></code></pre></td></tr></table></figure>

<p>如果只根据前面介绍规则进行优化，则生成的计划如下。生成该计划仅依赖于SQL语句的词法结构，因此此类优化器也被称为句法优化器（syntactic optimizer）。</p>
<figure class="highlight nestedtext"><table><tr><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-bullet">-</span> <span class="hljs-string">Aggregate[by nationkey...; orders_sum := sum(totalprice)]</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">InnerJoin[o.orderkey = l.orderkey]</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">InnerJoin[c.custkey = o.custkey]</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">InnerJoin[n.nationkey = c.nationkey]</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">TableScan[nation]</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">TableScan[custom</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">TableScan[orders]</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">TableScan[lineitem]</span><br></code></pre></td></tr></table></figure>

<p>如果稍微修改SQL语句的WHERE子句如下</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">SELECT</span><br>    n.name <span class="hljs-keyword">AS</span> nation_name,<br>    avg(extendedprice) <span class="hljs-keyword">as</span> avg_price<br><span class="hljs-keyword">FROM</span> nation n, orders o, customer c, lineitem l<br><span class="hljs-keyword">WHERE</span> c.custkey = o.custkey<br>  <span class="hljs-keyword">AND</span> o.orderkey = l.orderkey<br>  <span class="hljs-keyword">AND</span> n.nationkey = c.nationkey<br><span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> n.nationkey, n.name;<br></code></pre></td></tr></table></figure>

<p>那么生成的计划也有响应的变化，即join的顺序修改了</p>
<figure class="highlight css"><table><tr><td class="code"><pre><code class="hljs css">- Aggregate<span class="hljs-selector-attr">[by nationkey...; orders_sum := sum(totalprice)]</span><br>  - InnerJoin<span class="hljs-selector-attr">[n.nationkey = c.nationkey]</span><br>   - InnerJoin<span class="hljs-selector-attr">[o.orderkey = l.orderkey]</span><br>      - InnerJoin<span class="hljs-selector-attr">[c.custkey = o.custkey]</span><br>        - TableScan<span class="hljs-selector-attr">[customer]</span><br>        - TableScan<span class="hljs-selector-attr">[orders]</span><br>      - TableScan<span class="hljs-selector-attr">[lineitem]</span><br>    - TableScan<span class="hljs-selector-attr">[nation]</span><br></code></pre></td></tr></table></figure>

<p>可以看到简单的修改where条件的顺序就会影响查询计划，从而影响查询性能。显然不能要求用户根据内部的信息去创建一个最优的语句。而基于成本的优化器（cost-based optimizer）就能保证同一查询的不同SQL变体可以生成相同的优化查询计划。</p>
<p>除了时间复杂度之外，CPU时间、内存需求和网络带宽是影响查询执行时间的三个重要维度。 </p>
<h4 id="Cost-of-the-Join"><a href="#Cost-of-the-Join" class="headerlink" title="Cost of the Join"></a>Cost of the Join</h4><p>当使用相等条件连接两个表时，Presto采用hash join的实现方式。连接表中的某一个称为构建（<em>build</em>）端。此表用于构建以联接条件列为键的哈希表。另一个表称为探测（<em>probe</em> ）端。当哈希表构建完毕后，开始处理探测端的表记录。利用哈希表可以在常数时间内查找构建端匹配的记录。默认情况下，Presto使用三级哈希来尽可能地进行并行处理：</p>
<ol>
<li>两个连接表的数据都基于联接条件列的哈希值分布到不同的worker节点中。这种节点级别的数据分配（<em>node-level data assignment</em>）是第一层哈希。</li>
<li>在节点级别，构建端的数据进一步使用哈希函数分散在构建端的工作线程中。构建哈希表是一个CPU密集型的过程，使用多个线程来完成这项工作可以大大提高吞吐量。</li>
<li>Each worker thread ultimately produces one partition of the final lookup hash table. Each partition is a hash table itself. The partitions are combined into a two-level lookup hash table so that we avoid scattering the probe side across multiple threads as well. The probe side is still processed in multiple threads, but the threads get their work assigned in batches, which is faster than partitioning the data by using a hash function.</li>
</ol>
<p>为了利用告诉的内存计算，构建端需要一直保存在内存中，所以节点的内存须要能容纳构建端的数据。优化器会选择哪个表应该是构建表，从而控制连接的内存开销。</p>
<h4 id="Table-Statistics"><a href="#Table-Statistics" class="headerlink" title="Table Statistics"></a>Table Statistics</h4><p>在前面提到每个表都由连接器提供。除了表的schema信息和对实际数据的访问之外，连接器还可以提供表和列统计信息：</p>
<ul>
<li>表中的记录行数</li>
<li>列中不同值的数目</li>
<li>列中NULL值得比例</li>
<li>列得最大最小值</li>
<li>列得平均数据大小</li>
</ul>
<p>有了这些统计信息，基于成本的优化器就能决定最优的连接顺序。对于前面的例子，会从最大的表（lineitem）开始，然后依次连接orders, customer和nation。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><code class="hljs css">- Aggregate<span class="hljs-selector-attr">[by nationkey...; orders_sum := sum(totalprice)]</span><br>  - InnerJoin<span class="hljs-selector-attr">[l.orderkey = o.orderkey]</span><br>    - InnerJoin<span class="hljs-selector-attr">[o.custkey = c.custkey]</span><br>      - InnerJoin<span class="hljs-selector-attr">[c.nationkey = n.nationkey]</span><br>        - TableScan<span class="hljs-selector-attr">[lineitem]</span><br>        - TableScan<span class="hljs-selector-attr">[orders]</span><br>      - TableScan<span class="hljs-selector-attr">[customer]</span><br>    - TableScan<span class="hljs-selector-attr">[nation]</span><br></code></pre></td></tr></table></figure>

<p>上述是最优的连接顺序，但并不一定是最优的查询计划。在Presto中设置以下属性</p>
<figure class="highlight ebnf"><table><tr><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">SET SESSION join_reordering_strategy</span> = <span class="hljs-string">&#x27;AUTOMATIC&#x27;</span>;<br></code></pre></td></tr></table></figure>

<p>那么Presto可能会选择以下计划， 因为这样避免了通过网络发送三次最大的表（lineitem）。最终的计划取决于连接表的实际大小以及集群中的节点数量。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><code class="hljs css">- Aggregate<span class="hljs-selector-attr">[by nationkey...; orders_sum := sum(totalprice)]</span><br>  - InnerJoin<span class="hljs-selector-attr">[l.orderkey = o.orderkey]</span><br>   - TableScan<span class="hljs-selector-attr">[lineitem]</span><br>   - InnerJoin<span class="hljs-selector-attr">[o.custkey = c.custkey]</span><br>      - TableScan<span class="hljs-selector-attr">[orders]</span><br>      - InnerJoin<span class="hljs-selector-attr">[c.nationkey = n.nationkey]</span><br>        - TableScan<span class="hljs-selector-attr">[customer]</span><br>        - TableScan<span class="hljs-selector-attr">[nation]</span><br></code></pre></td></tr></table></figure>



<h4 id="Filter-Statistics"><a href="#Filter-Statistics" class="headerlink" title="Filter Statistics"></a>Filter Statistics</h4><p>当增加过滤条件之后，也可能会改变join的顺序。在前面的查询例子中加上l.partkey = 638的过滤条件。在加此过滤条件之前lineitem是最大的表，而加了过滤条件之后，则变成了所有参与连接的关系中最小的了。</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">SELECT</span><br>    n.name <span class="hljs-keyword">AS</span> nation_name,<br>    avg(extendedprice) <span class="hljs-keyword">as</span> avg_price<br><span class="hljs-keyword">FROM</span> nation n, orders o, customer c, lineitem l<br><span class="hljs-keyword">WHERE</span> n.nationkey = c.nationkey<br>  <span class="hljs-keyword">AND</span> c.custkey = o.custkey<br>  <span class="hljs-keyword">AND</span> o.orderkey = l.orderkey<br>  <span class="hljs-keyword">AND</span> l.partkey = <span class="hljs-number">638</span><br><span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> n.nationkey, n.name;<br></code></pre></td></tr></table></figure>

<p>此时CBO生成的计划如下</p>
<figure class="highlight css"><table><tr><td class="code"><pre><code class="hljs css">- Aggregate<span class="hljs-selector-attr">[by nationkey...; orders_sum := sum(totalprice)]</span><br>  - InnerJoin<span class="hljs-selector-attr">[l.orderkey = o.orderkey]</span><br>   - InnerJoin<span class="hljs-selector-attr">[o.custkey = c.custkey]</span><br>      - TableScan<span class="hljs-selector-attr">[customer]</span><br>      - InnerJoin<span class="hljs-selector-attr">[c.nationkey = n.nationkey]</span><br>        - TableScan<span class="hljs-selector-attr">[orders]</span><br>        - <span class="hljs-attribute">Filter</span><span class="hljs-selector-attr">[partkey = 638]</span><br>          - TableScan<span class="hljs-selector-attr">[lineitem]</span><br>    - TableScan<span class="hljs-selector-attr">[nation]</span><br></code></pre></td></tr></table></figure>



<p>CBO会根据统计信息来估计过滤的记录数，一个简单的估计方法如下：即先剔除该列为空的记录数，然后认为不为空时是均匀分布的。当然更合理的估算采用直方图（histogram）。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql">filtered <span class="hljs-keyword">rows</span> <span class="hljs-operator">=</span> unfiltered <span class="hljs-keyword">rows</span> <span class="hljs-operator">*</span> (<span class="hljs-number">1</span> <span class="hljs-operator">-</span> <span class="hljs-keyword">null</span> fraction) <span class="hljs-operator">/</span> number <span class="hljs-keyword">of</span> <span class="hljs-keyword">distinct</span> <span class="hljs-keyword">values</span><br></code></pre></td></tr></table></figure>



<h4 id="Table-Statistics-for-Partitioned-Tables"><a href="#Table-Statistics-for-Partitioned-Tables" class="headerlink" title="Table Statistics for Partitioned Tables"></a>Table Statistics for Partitioned Tables</h4><p>过滤表的一个特殊情况是分区表，比如Hive中的数据仓库。当过滤条件中包含分区键时，那么只需要读取匹配的分区即可，而且表的统计信息也是分区级别的。</p>
<h4 id="Join-Enumeration"><a href="#Join-Enumeration" class="headerlink" title="Join Enumeration"></a>Join Enumeration</h4><p>到目前为止，我们提到的CBO基于统计信息选择了一个最佳的连接顺序，这会在很大程度上影响查询性能，主要有两个原因：</p>
<ul>
<li><em>Hash join 实现</em> ：hash join不是对称的，需要合理选择构建端和探测端</li>
<li><em>分布式join</em> ：需要判断是将数据广播（broadcast）还是重新分发（redistribute）给连接输入</li>
</ul>
<h5 id="Broadcast-Versus-Distributed-Joins"><a href="#Broadcast-Versus-Distributed-Joins" class="headerlink" title="Broadcast Versus Distributed Joins"></a>Broadcast Versus Distributed Joins</h5><p><strong>Broadcast join strategy</strong></p>
<p>在broadcast join策略中，连接的构建端会广播给所有的工作节点。只有当分布在工作节点上的探测端没有重复数据时，语义上才是是正确的；否则，将生成重复的结果。</p>
<img src="ptdg_0412.png" alt="Broadcast join strategy visualization" style="zoom: 67%;" />

<p>当构建端的表很小或探测端的表很大时，采用该策略是有益的。</p>
<p><strong>Distributed join strategy</strong></p>
<p>在distributed join策略下，探测端和构建段的数据都会在集群中重分布以并行地执行join操作。重分布需要借助分区算法以使得可能匹配的数据被发送到同一节点。</p>
<p>通过数据分区，可以应对连接的两个表都很大或内存不足的情况。缺点就是需要通过网络传输额外的数据。</p>
</div></article><div class="post-view__sidebar"><div class="sidebar"><div class="tocbot"><h2>Toc</h2><div class="toc__content"></div></div><h2>Links</h2><div class="sidebar__link"><ul><li><a href="mailto:baoqp1@163.com">Mail</a></li></ul></div><h2>Archives</h2><div class="sidebar__archives"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/">2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/">2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/">2019</a></li></ul></div><h2>Categories</h2><div class="sidebar__categories"></div><h2>Tags</h2><div class="sidebar__tags"><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/BookKeeper/" rel="tag">BookKeeper</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cassandra/" rel="tag">Cassandra</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HBase/" rel="tag">HBase</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Parser-combinator/" rel="tag">Parser combinator</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Presto/" rel="tag">Presto</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Pulasr/" rel="tag">Pulasr</a></li></ul></div></div></div></div><div class="horizontal-line" style="height: 1px"></div><div class="main__bottom"><div class="pre-next"><a class="pre-button" href="/2021/05/30/Parser-combinator%E5%88%9D%E6%8E%A22-%E8%A1%A8%E8%BE%BE%E5%BC%8F%E8%A7%A3%E6%9E%90%E4%B8%8E%E5%BA%94%E7%94%A8/">Parser combinator初探2-表达式解析与应用</a><a class="next-button" href="/2020/03/07/Parser-combinator%E5%88%9D%E6%8E%A21-%E7%AE%80%E6%98%93JSON%E8%A7%A3%E6%9E%90%E5%99%A8/">Parser combinator初探1-简易JSON解析器</a></div></div></div></div><div class="footer"><span>©️2019-2022 Designed By&nbsp;<strong><a target="_blank" rel="noopener" href="https://github.com/random-yang">RandomYang</a></strong> Powered By&nbsp;</span><strong><a target="_blank" rel="noopener" href="https://hexo.io">hexo</a></strong></div><div class="darkmode-mask" id="darkmode-mask"></div><div class="sidebar__button"></div></body></html>